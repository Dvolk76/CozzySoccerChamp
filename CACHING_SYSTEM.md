# Система кэширования для CozySoccerChamp

## Обзор

Реализована система кэширования данных с автоматическим обновлением для соблюдения лимитов Football Data API (10 запросов в минуту) и обеспечения актуальности данных для пользователей.

## Архитектура

### Серверная часть

#### Кэш-сервис (`src/services/cache.ts`)

**Основные компоненты:**
- `DataCache` - главный класс для управления кэшем
- `CachedDataService` - сервис для работы с кэшированными данными приложения

**Функции:**
- **TTL (Time To Live)**: Каждый элемент кэша имеет время жизни (по умолчанию 1 минута)
- **Автообновление**: Данные автоматически обновляются за 10% до истечения TTL
- **Защита от дублирования**: Предотвращает множественные одновременные запросы к API
- **Fallback**: Возвращает устаревшие данные при ошибке обновления

**Кэшируемые данные:**
- `matches` - список матчей (TTL: 1 минута)
- `leaderboard` - таблица лидеров (TTL: 1 минута) 
- `api_sync_{season}` - синхронизация с Football Data API (TTL: 1 минута)

#### Автоматическая синхронизация

В `src/index.ts` настроена автоматическая синхронизация:
- Первичная синхронизация через 5 секунд после запуска сервера
- Последующие синхронизации каждые 60 секунд
- Логирование всех операций

### Клиентская часть

#### Хуки для автообновления

**`useAutoRefresh.ts`:**
- `useAutoRefresh` - базовый хук для автообновления данных
- `useDataPolling` - хук с поддержкой видимости страницы и фокуса

**`useData.ts`:**
- `useMatches` - хук для получения матчей с автообновлением (30 сек)
- `useLeaderboard` - хук для получения лидерборда с автообновлением (30 сек)
- `useUserPredictions` - хук для прогнозов пользователя (без автообновления)
- `useCacheStats` - хук для админ-статистики кэша (10 сек)

#### Оптимизации клиента

- **Пауза при неактивной вкладке**: Автообновление останавливается, когда вкладка неактивна
- **Обновление при возврате**: Данные обновляются при возврате к вкладке
- **Индикаторы состояния**: Показываются статусы загрузки и время последнего обновления

## API Endpoints

### Новые админские эндпоинты

- `POST /api/admin/refresh-cache` - принудительное обновление всего кэша
- `GET /api/admin/cache-stats` - статистика кэша (возраст, TTL, статус)

### Обновленные эндпоинты

- `GET /api/matches` - теперь использует кэш
- `GET /api/leaderboard` - теперь использует кэш  
- `POST /api/admin/sync` - теперь с защитой от лимитов API

## Конфигурация

### Настройки кэша

```typescript
// TTL для разных типов данных
const CACHE_TTL = {
  matches: 60000,      // 1 минута
  leaderboard: 60000,  // 1 минута
  api_sync: 60000,     // 1 минута
};

// Интервалы автообновления на клиенте
const POLLING_INTERVALS = {
  matches: 30000,      // 30 секунд
  leaderboard: 30000,  // 30 секунд
  cacheStats: 10000,   // 10 секунд
};
```

### Переменные окружения

Система использует существующие переменные:
- `FOOTBALL_DATA_API_TOKEN` - токен для Football Data API
- `LOG_LEVEL` - уровень логирования

## Мониторинг

### Логирование

Все операции кэша логируются с уровнем `info`:
- Попадания в кэш (cache hit)
- Промахи кэша (cache miss)
- Автообновления
- Ошибки синхронизации

### Админ-панель

В админ-панели доступна статистика кэша:
- Возраст каждого элемента кэша
- Статус (актуален/истек)
- Кнопка принудительного обновления

## Защита от лимитов API

1. **Кэширование запросов**: API вызывается максимум раз в минуту
2. **Дедупликация**: Множественные запросы к одним данным объединяются
3. **Fallback на устаревшие данные**: При ошибке API возвращаются последние успешные данные
4. **Автоматическое восстановление**: При ошибках система пытается восстановиться через интервалы

## Преимущества

1. **Соблюдение лимитов**: Не более 10 API запросов в минуту
2. **Актуальность данных**: Пользователи видят свежие данные каждые 30 секунд
3. **Отказоустойчивость**: Система продолжает работать при временных проблемах с API
4. **Производительность**: Быстрая отдача данных из кэша
5. **UX**: Индикаторы загрузки и времени последнего обновления

## Мониторинг и отладка

### Логи сервера
```bash
# Просмотр логов кэша
grep "Cache" logs/server.log

# Просмотр логов API синхронизации
grep "API sync" logs/server.log
```

### Админ-панель
- Статистика кэша в реальном времени
- Возможность принудительного обновления
- Мониторинг времени жизни элементов кэша
